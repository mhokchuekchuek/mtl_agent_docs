flowchart LR
    subgraph Sync Path
        1[1. User message] --> 2[2. Process LLM]
        2 --> 3[3. Response]
        3 --> 4[4. Redis checkpoint only]
        4 --> 5[5. Return to user]
    end

    subgraph Scheduled Job - Every 5 mins
        R[(Redis)] --> J[Orchestrator]
        J --> |Check TTL| D{TTL < 10 min?}
        D --> |Yes| P[(Postgres)]
        D --> |No| Skip[Skip]
    end

    classDef user fill:#dbeafe,stroke:#3b82f6,stroke-width:2px,color:#1e40af
    classDef llm fill:#ede9fe,stroke:#8b5cf6,stroke-width:2px,color:#5b21b6
    classDef response fill:#cffafe,stroke:#06b6d4,stroke-width:2px,color:#0e7490
    classDef redis fill:#fce7f3,stroke:#ec4899,stroke-width:2px,color:#be185d
    classDef decision fill:#fef3c7,stroke:#f59e0b,stroke-width:2px,color:#b45309
    classDef postgres fill:#d1fae5,stroke:#10b981,stroke-width:2px,color:#065f46

    class 1 user
    class 2 llm
    class 3 response
    class 4,R redis
    class 5 response
    class J,D decision
    class P postgres
    class Skip response
