flowchart TB
    subgraph User["User Request"]
        Q[Complex Query]
    end

    subgraph DeepAgent["Deep Client Agent"]
        subgraph Planning["Planning Layer"]
            WP[write_plan]
            RP[read_plan]
        end

        subgraph Execution["Execution Layer"]
            TASK[task tool]
        end

        subgraph Subagents["Subagents"]
            SQL[SQL Analyst]
            VIZ[Visualizer]
            RES[Researcher]
        end

        subgraph Context["Context Management"]
            SS[Scratch Space]
            RS[Read Scratch]
        end
    end

    subgraph Tools["Existing Tools"]
        ASQL[AnalyticsSQLTool]
        CSQL[ChatHistorySQLTool]
        VTOOL[VisualizationTool]
    end

    subgraph Storage["Storage Layer"]
        PG[(PostgreSQL Store)]
    end

    Q --> WP
    WP --> TASK
    TASK --> SQL
    TASK --> VIZ
    TASK --> RES

    SQL --> ASQL
    SQL --> CSQL
    RES --> CSQL
    VIZ --> VTOOL

    SQL --> SS
    RES --> SS
    SS --> PG
    RS --> PG
    VIZ --> RS

    classDef user fill:#dbeafe,stroke:#3b82f6,stroke-width:2px,color:#1e40af
    classDef planning fill:#fef3c7,stroke:#f59e0b,stroke-width:2px,color:#b45309
    classDef execution fill:#ede9fe,stroke:#8b5cf6,stroke-width:2px,color:#5b21b6
    classDef agent fill:#cffafe,stroke:#06b6d4,stroke-width:2px,color:#0e7490
    classDef context fill:#fce7f3,stroke:#ec4899,stroke-width:2px,color:#be185d
    classDef tool fill:#d1fae5,stroke:#10b981,stroke-width:2px,color:#065f46
    classDef db fill:#fed7aa,stroke:#f97316,stroke-width:2px,color:#c2410c

    class Q user
    class WP,RP planning
    class TASK execution
    class SQL,VIZ,RES agent
    class SS,RS context
    class ASQL,CSQL,VTOOL tool
    class PG db