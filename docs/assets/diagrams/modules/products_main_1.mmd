flowchart TD
    A[1. Get Prompt from Langfuse] --> B[2. Build ReAct agent with tools]
    B --> C[3. Set customer_id on tools if provided]
    C --> D[4. Build messages with history]
    D --> E[5. LLM decides action]
    E --> F{What does user need?}
    F -->|Search products| G[ProductSQLTool / ProductSearchTool]
    F -->|Check orders| H[OrderSQLTool]
    F -->|Place order| I[PlaceOrderSQLTool]
    F -->|Cancel order| J[CancelOrderSQLTool]
    G --> K[Return response]
    H --> K
    I --> K
    J --> K

    classDef prompt fill:#dbeafe,stroke:#3b82f6,stroke-width:2px,color:#1e40af
    classDef agent fill:#cffafe,stroke:#06b6d4,stroke-width:2px,color:#0e7490
    classDef decision fill:#fef3c7,stroke:#f59e0b,stroke-width:2px,color:#b45309
    classDef tool fill:#d1fae5,stroke:#10b981,stroke-width:2px,color:#065f46
    classDef output fill:#ede9fe,stroke:#8b5cf6,stroke-width:2px,color:#5b21b6

    class A prompt
    class B,C,D,E agent
    class F decision
    class G,H,I,J tool
    class K output
