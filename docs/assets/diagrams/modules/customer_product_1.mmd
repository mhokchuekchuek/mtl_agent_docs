flowchart TD
    START[Customer asks about products] --> PROMPT[1. Load prompt from Langfuse]

    PROMPT --> SCHEMA[2. Get schema for allowed tables only]
    SCHEMA --> |Products, Inventory| COMPILE[3. Compile prompt]

    COMPILE --> LLM[4. LLM generates SQL]
    LLM --> VALIDATE[5. Validate SQL]

    VALIDATE --> CHECK_TABLES{Tables allowed?}
    CHECK_TABLES --> |No| REJECT[Reject: Forbidden table access]

    CHECK_TABLES --> |Yes| CHECK_SAFE{SQL is safe?}
    CHECK_SAFE --> |No| REJECT2[Reject: Security violation]

    CHECK_SAFE --> |Yes| EXECUTE[6. Execute SQL]
    EXECUTE --> |Query| PROD_TBL[(Products)]
    EXECUTE --> |Query| INV_TBL[(Inventory)]

    PROD_TBL --> RESULTS[7. Return results]
    INV_TBL --> RESULTS

    classDef start fill:#dbeafe,stroke:#3b82f6,stroke-width:2px,color:#1e40af
    classDef process fill:#cffafe,stroke:#06b6d4,stroke-width:2px,color:#0e7490
    classDef decision fill:#fef3c7,stroke:#f59e0b,stroke-width:2px,color:#b45309
    classDef error fill:#fee2e2,stroke:#ef4444,stroke-width:2px,color:#b91c1c
    classDef db fill:#fce7f3,stroke:#ec4899,stroke-width:2px,color:#be185d
    classDef output fill:#d1fae5,stroke:#10b981,stroke-width:2px,color:#065f46

    class START start
    class PROMPT,SCHEMA,COMPILE,LLM,VALIDATE,EXECUTE process
    class CHECK_TABLES,CHECK_SAFE decision
    class REJECT,REJECT2 error
    class PROD_TBL,INV_TBL db
    class RESULTS output
