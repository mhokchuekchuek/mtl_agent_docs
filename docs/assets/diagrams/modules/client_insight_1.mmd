flowchart TD
    A[1. Get Prompt from Langfuse] --> B[2. Build ReAct agent with tools]
    B --> C[3. Build messages with history]
    C --> D[4. LLM decides action]
    D --> E{Need SQL data?}
    E -->|Yes| F[Call SQLTool]
    F --> G{Need visualization?}
    E -->|No| G
    G -->|Yes| H[Call VisualizationTool]
    H --> I[Return response + chart]
    G -->|No| J[Return response only]

    classDef prompt fill:#dbeafe,stroke:#3b82f6,stroke-width:2px,color:#1e40af
    classDef agent fill:#cffafe,stroke:#06b6d4,stroke-width:2px,color:#0e7490
    classDef decision fill:#fef3c7,stroke:#f59e0b,stroke-width:2px,color:#b45309
    classDef tool fill:#d1fae5,stroke:#10b981,stroke-width:2px,color:#065f46
    classDef viz fill:#fce7f3,stroke:#ec4899,stroke-width:2px,color:#be185d
    classDef output fill:#ede9fe,stroke:#8b5cf6,stroke-width:2px,color:#5b21b6

    class A prompt
    class B,C,D agent
    class E,G decision
    class F tool
    class H viz
    class I,J output
